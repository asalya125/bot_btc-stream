#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ü™ô Crypto Mini-Bot
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –±–∏—Ç–∫–æ–∏–Ω–∞.
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–≥–æ Telegram-–±–æ—Ç–∞ —Å —Ñ–æ–Ω–æ–≤—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.
"""

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å 'os' –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)
import os

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å 'time' –¥–ª—è –ø–∞—É–∑ (sleep) –∏ —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
import time

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª—å 'threading' –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ (—á—Ç–æ–±—ã –±–æ—Ç –Ω–µ –∑–∞–≤–∏—Å–∞–ª –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
import threading

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É 'requests' –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–∞–π—Ç–æ–≤/API)
import requests

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É 'telebot' (pyTelegramBotAPI) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram-–±–æ—Ç–æ–º
import telebot
from telebot import types

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é 'load_dotenv' –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ —Ñ–∞–π–ª–∞ .env (—á—Ç–æ–±—ã –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª–∏ –≤ –∫–æ–¥–µ)
from dotenv import load_dotenv

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ù–∞—Å—Ç—Ä–æ–π–∫–∏) ---

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ .env –≤ –ø–∞–º—è—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã
load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç, –≤–µ—Ä–Ω–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
BOT_TOKEN = os.getenv("BOT_TOKEN", "")

# –ü–æ–ª—É—á–∞–µ–º URL –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ Telegram).
PROXY_URL = os.getenv("PROXY_URL", "")

# –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω, –º—ã –Ω–µ –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞, –ø–æ—ç—Ç–æ–º—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–∏–ø—Ç.
if not BOT_TOKEN:
    raise ValueError("‚ùå BOT_TOKEN –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ñ–∞–π–ª–µ .env")

# –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø—Ä–æ–∫—Å–∏, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É telebot, —á—Ç–æ–±—ã –æ–Ω–∞ —Ö–æ–¥–∏–ª–∞ —á–µ—Ä–µ–∑ –Ω–µ–≥–æ.
if PROXY_URL:
    from telebot import apihelper
    # –£–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–∫—Å–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è HTTPS-–∑–∞–ø—Ä–æ—Å–æ–≤ (Telegram API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HTTPS)
    apihelper.proxy = {'https': PROXY_URL}
    print(f"üåê –ü—Ä–æ–∫—Å–∏ –≤–∫–ª—é—á–µ–Ω: {PROXY_URL}")

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞. –≠—Ç–æ –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π "–ø—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ Telegram.
bot = telebot.TeleBot(BOT_TOKEN)

# --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –°–æ—Å—Ç–æ—è–Ω–∏–µ (–ü–∞–º—è—Ç—å –±–æ—Ç–∞) ---

# –°–ª–æ–≤–∞—Ä—å 'subscribers' —Ö—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, –∫—É–¥–∞ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
# –ö–ª—é—á (Key): chat_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
# –ó–Ω–∞—á–µ–Ω–∏–µ (Value): message_id (–Ω–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)
# –ü—Ä–∏–º–µ—Ä: {12345678: 105, 87654321: 44}
subscribers = {}

# –°–æ–∑–¥–∞–µ–º "–±–ª–æ–∫–∏—Ä–æ–≤–∫—É" (Lock). –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤.
# –ö–æ–≥–¥–∞ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ (update loop) –º–µ–Ω—è–µ—Ç —Å–ª–æ–≤–∞—Ä—å subscribers, –¥—Ä—É–≥–æ–π (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥) –Ω–µ –¥–æ–ª–∂–µ–Ω –º–µ—à–∞—Ç—å.
# –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ –¥–∞–Ω–Ω—ã–º.
LOCK = threading.Lock()

def fetch_btc_price():
    """
    –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É BTC —á–µ—Ä–µ–∑ API —Å–∞–π—Ç–∞ Blockchain.info.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–µ–Ω—É (float) –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    try:
        # URL –∞–¥—Ä–µ—Å –ø—É–±–ª–∏—á–Ω–æ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ API, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–¥–∞–µ—Ç —Ü–µ–Ω—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
        url = "https://blockchain.info/ticker"
        
        # –î–µ–ª–∞–µ–º GET-–∑–∞–ø—Ä–æ—Å –∫ —Å–∞–π—Ç—É. –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –Ω–µ –±–æ–ª–µ–µ 10 —Å–µ–∫—É–Ω–¥ (timeout=10).
        resp = requests.get(url, timeout=10) #—ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP GET-–∑–∞–ø—Ä–æ—Å –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É URL.
        
        # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –Ω–µ 200 (–û–ö), —ç—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É.
        resp.raise_for_status()
        
        # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç (—Ç–µ–∫—Å—Ç) –≤ Python-—Å–ª–æ–≤–∞—Ä—å (JSON)
        data = resp.json()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON: {"USD": {"last": 90000.0, ...}, ...}
        # –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É "last" –≤–Ω—É—Ç—Ä–∏ "USD".
        return float(data["USD"]["last"])
        
    except Exception as e:
        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ª—é–±–∞—è –æ—à–∏–±–∫–∞ (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, —Å–∞–π—Ç –ª–µ–∂–∏—Ç), –ø–∏—à–µ–º –µ—ë –≤ –∫–æ–Ω—Å–æ–ª—å
        print(f"[–û—à–∏–±–∫–∞ API BTC] {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º None, —á—Ç–æ–±—ã –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–Ω–∞–ª–∞, —á—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
        return None

def fetch_stablecoin_flow():
    """
    –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–∞–º (USDT, USDC –∏ –¥—Ä.) —Å —Å–µ—Ä–≤–∏—Å–∞ DefiLlama.
    –ú—ã —Å—á–∏—Ç–∞–µ–º 'Net Flow' –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (Mint/Burn) –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞.
    """
    try:
        # –°—Å—ã–ª–∫–∞ –Ω–∞ API DefiLlama —Å–æ —Å–ø–∏—Å–∫–æ–º —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤
        url = "https://stablecoins.llama.fi/stablecoins?includePrices=true"
        # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å (timeout=15 —Å–µ–∫—É–Ω–¥, —á—É—Ç—å –±–æ–ª—å—à–µ, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ)
        resp = requests.get(url, timeout=15)
        resp.raise_for_status()
        data = resp.json()#JSON ‚Äî —ç—Ç–æ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –º–µ–∂–¥—É –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏. –ü–æ—Ö–æ–∂ –Ω–∞ —Å–ª–æ–≤–∞—Ä—å –≤ Python, –Ω–æ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ.
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ 'peggedAssets'(—Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤) –≤ –æ—Ç–≤–µ—Ç–µ JSON
        if "peggedAssets" not in data:
            return None, None
            
        # –ù–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã —Ç–æ–ª—å–∫–æ —Ç–æ–ø–æ–≤—ã–µ —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω—ã, —á—Ç–æ–±—ã –Ω–µ —Å—á–∏—Ç–∞—Ç—å –º—É—Å–æ—Ä.
        top_symbols = {"USDT", "USDC", "DAI", "FDUSD", "USDe"}
        
        # –§–∏–ª—å—Ç—Ä—É–µ–º (–æ—Ç–±–∏—Ä–∞–µ–º) –∏–∑ –æ–±—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –µ—Å—Ç—å –≤ –Ω–∞—à–µ–º top_symbols
        assets = [a for a in data["peggedAssets"] if a["symbol"] in top_symbols]
        
        total_supply = 0  # –û–±—â–∞—è –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è
        net_flow_24h = 0  # –û–±—â–∏–π –ø–æ—Ç–æ–∫ –∑–∞ 24—á (–ø—Ä–∏—Ç–æ–∫ - –æ—Ç—Ç–æ–∫)
        
        for a in assets:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ü–∏—Ä–∫—É–ª–∏—Ä—É—é—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (circulating -> peggedUSD)
            # 'test' or 0 ‚Äî –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –±–µ—Ä–µ–º 0
            circ = a.get("circulating", {}).get("peggedUSD", 0) or 0
            
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—ã–ª–æ –≤—á–µ—Ä–∞ (circulatingPrevDay)
            prev_circ = a.get("circulatingPrevDay", {}).get("peggedUSD", 0) or 0
            
            # –°—á–∏—Ç–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ. –ï—Å–ª–∏ –≤—á–µ—Ä–∞—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç (0), —Å—á–∏—Ç–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ 0, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–∫–∞—á–∫–æ–≤.
            change = circ - prev_circ if prev_circ > 0 else 0
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–∏–º —Å—É–º–º–∞–º
            total_supply += circ
            net_flow_24h += change
            
        return total_supply, net_flow_24h
        
    except Exception as e:
        # –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö
        print(f"[–û—à–∏–±–∫–∞ API Stables] {e}")
        return None, None

def get_message_text(price, supply, flow):
    """
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ü–µ–Ω—É, –æ–±—ä–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤.
    """
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É BTC: –µ—Å–ª–∏ –µ—Å—Ç—å, –¥–µ–ª–∞–µ–º "$90,000.00", –∏–Ω–∞—á–µ "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
    if price:
        btc_text = f"${price:,.2f}"
    else:
        btc_text = "Unavailable"
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω—ã
    if supply is not None and flow is not None:
        # –î–ª—è –ø–æ—Ç–æ–∫–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞–∫ "+" –µ—Å–ª–∏ —á–∏—Å–ª–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
        sign = "+" if flow >= 0 else ""
        # –î–µ–ª–∏–º –Ω–∞ 1 –º–∏–ª–ª–∏–æ–Ω (1e6) –∏ –ø–∏—à–µ–º 'M'
        flow_text = f"{sign}${flow/1e6:,.2f}M"
        # –î–µ–ª–∏–º –Ω–∞ 1 –º–∏–ª–ª–∏–∞—Ä–¥ (1e9) –∏ –ø–∏—à–µ–º 'B'
        supply_text = f"${supply/1e9:,.2f}B"
    else:
        flow_text = "N/A"
        supply_text = "N/A"
        
    # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞ (—á—Ç–æ–±—ã –≤–∏–¥–Ω–æ –±—ã–ª–æ, —á—Ç–æ –±–æ—Ç –∂–∏–≤–æ–π)
    timestamp = time.strftime("%H:%M:%S")#–≤—Ä–µ–º—è –≤ —Å—Ç—Ä–æ–∫–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—É—é —Å—Ç—Ä–æ–∫—É (f-string)
    # –ó–≤–µ–∑–¥–æ—á–∫–∏ (*) –≤ —Ç–µ–∫—Å—Ç–µ –Ω—É–∂–Ω—ã –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞ –≤ Markdown
    # [–¢–µ–∫—Å—Ç](—Å—Å—ã–ª–∫–∞) —Å–æ–∑–¥–∞–µ—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
    return (
        f"üìä *Crypto Live*\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üí∞ BTC: *{btc_text}*\n\n"
        f"üêã *Whale Alert (24h)*\n"
        f"üåä Stablecoin Net Flow: *{flow_text}*\n"
        f"üè¶ Stablecoin Supply: *{supply_text}*\n"
        f"üîó [Check Exchange Flows](https://whale-alert.io)\n\n"
        f"üïí Updated: {timestamp}"
    )

def broadcast_loop():
    """
    –§—É–Ω–∫—Ü–∏—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ (Thread).
    –û–Ω–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ—á–Ω–æ –≤ —Ü–∏–∫–ª–µ (while True).
    –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –æ–Ω–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Å–µ—Ö —á–∞—Ç–∞—Ö.
    """
    print("üîÅ –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω.")
    while True:
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
            price = fetch_btc_price()
            supply, flow = fetch_stablecoin_flow()
            
            # 2. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
            text = get_message_text(price, supply, flow)
            
            # 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∫–æ–ø–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
            # –ï—Å–ª–∏ –º—ã –±—É–¥–µ–º –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å —Å–ª–æ–≤–∞—Ä—å (for key in dict) –∏ —É–¥–∞–ª—è—Ç—å –∏–∑ –Ω–µ–≥–æ –∫–ª—é—á–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ,
            # Python –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É "dictionary changed size during iteration".
            # –ü–æ—ç—Ç–æ–º—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º LOCK –∏ –¥–µ–ª–∞–µ–º –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ (list(subscribers.items())).
            with LOCK: #—ç—Ç–æ –æ–±—ä–µ–∫—Ç-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–µ–Ω–∏–µ  –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—â–∏–º —Ä–µ—Å—É—Ä—Å–∞–º –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤.
                targets = list(subscribers.items())
            
            # 4. –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            for chat_id, msg_id in targets:
                try:
                    # –ú–µ—Ç–æ–¥ edit_message_text –º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
                    # –≠—Ç–æ –∫—Ä—É—á–µ, —á–µ–º —Å–ª–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (–Ω–µ —Å–ø–∞–º–∏—Ç).
                    bot.edit_message_text(
                        text, 
                        chat_id=chat_id, 
                        message_id=msg_id, 
                        parse_mode="Markdown", #–í–∫–ª—é—á–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.
                        disable_web_page_preview=True, # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–≤—å—é —Å—Å—ã–ª–∫–∏
                        reply_markup=get_keyboard() #–î–æ–±–∞–≤–ª—è–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
                    )
                except Exception as e:
                    # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç "message is not modified", –∑–Ω–∞—á–∏—Ç —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–º–µ–Ω—è–ª—Å—è (—Ü–µ–Ω–∞ —Ç–∞ –∂–µ).
                    # –≠—Ç–æ –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º.
                    if "message is not modified" not in str(e):
                        # –ï—Å–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞), —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
                        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è {chat_id}: {e}")
                        with LOCK:
                            # –£–¥–∞–ª—è–µ–º chat_id –∏–∑ —Å–ª–æ–≤–∞—Ä—è, —á—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–ª—è—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞
                            subscribers.pop(chat_id, None#—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É
                            
            # 5. –ó–∞—Å—ã–ø–∞–µ–º –Ω–∞ 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            time.sleep(60)
            
        except Exception as e:
            # –ï—Å–ª–∏ —Å–ª–æ–º–∞–ª—Å—è —Å–∞–º —Ü–∏–∫–ª (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞), –ø–∏—à–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –∂–¥–µ–º, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –æ—à–∏–±–∫–∞–º–∏
            print(f"üí• –û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ: {e}")
            time.sleep(20)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram (Handlers) ---

# –≠—Ç–æ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –≥–æ–≤–æ—Ä–∏—Ç: "–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–º–∞–Ω–¥—ã /start –∏–ª–∏ /status –≤—ã–ø–æ–ª–Ω—è–π —Ñ—É–Ω–∫—Ü–∏—é –Ω–∏–∂–µ"
# --- –£—Ç–∏–ª–∏—Ç—ã UI ---

def get_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ (Interactivity 5 –±–∞–ª–ª–æ–≤)"""
    markup = types.InlineKeyboardMarkup()
    btn_source = types.InlineKeyboardButton("üîó Whale Alert", url="https://whale-alert.io")
    btn_defi = types.InlineKeyboardButton("ü¶ô DefiLlama", url="https://defillama.com/stablecoins")
    markup.add(btn_source, btn_defi)
    return markup

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram (Handlers) ---

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
@bot.message_handler(commands=["help"])
def cmd_help(message):
    help_text = (
        "ü§ñ *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É*\n\n"
        "–≠—Ç–æ—Ç –±–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ü–µ–Ω—É BTC –∏ –ø–æ—Ç–æ–∫–∏ —Å—Ç–µ–π–±–ª–∫–æ–∏–Ω–æ–≤.\n\n"
        "üî∏ */start* ‚Äî –∑–∞–ø—É—Å–∫/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n"
        "üî∏ */stop* ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n"
        "üî∏ */help* ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "–î–∞–Ω–Ω—ã–µ: Blockchain.info & DefiLlama"
    )
    bot.send_message(message.chat.id, help_text, parse_mode="Markdown")

@bot.message_handler(commands=["start", "status"])
def cmd_status(message):
    """
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —é–∑–µ—Ä –ø–∏—à–µ—Ç /start –∏–ª–∏ /status.
    –û–Ω–∞ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —é–∑–µ—Ä–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    chat_id = message.chat.id
    
    # 1. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É "–ó–∞–≥—Ä—É–∑–∫–∞...", —á—Ç–æ–±—ã —é–∑–µ—Ä –≤–∏–¥–µ–ª —Ä–µ–∞–∫—Ü–∏—é —Å—Ä–∞–∑—É
    msg = bot.send_message(chat_id, "‚è≥ –ü–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ...", parse_mode="Markdown")
    
    # 2. –¢—É—Ç –∂–µ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    price = fetch_btc_price()
    supply, flow = fetch_stablecoin_flow()
    text = get_message_text(price, supply, flow)
    
    # 3. –ó–∞–º–µ–Ω—è–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..." –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    bot.edit_message_text(
        text, 
        chat_id=chat_id, 
        message_id=msg.message_id, 
        parse_mode="Markdown",
        disable_web_page_preview=True,
        reply_markup=get_keyboard()
    )
    
    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —á–∞—Ç–∞ –∏ –Ω–æ–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
    # –¢–µ–ø–µ—Ä—å —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ –±—É–¥–µ—Ç –∑–Ω–∞—Ç—å, –∫–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è—Ç—å.
    with LOCK:
        subscribers[chat_id] = msg.message_id

@bot.message_handler(commands=["stop"])
def cmd_stop(message):
    """–ö–æ–º–∞–Ω–¥–∞ /stop —É–¥–∞–ª—è–µ—Ç —é–∑–µ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤."""
    with LOCK:
        # –£–¥–∞–ª—è–µ–º –∫–ª—é—á –∏–∑ —Å–ª–æ–≤–∞—Ä—è (pop)
        subscribers.pop(message.chat.id, None)
    
    bot.send_message(message.chat.id, "üõë –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")

def main():
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! (Mini-Bot v2)")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ (broadcast_loop)
    # daemon=True –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å–ª–∏ –º—ã –∑–∞–∫—Ä–æ–µ–º –≥–ª–∞–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É, —ç—Ç–æ—Ç –ø–æ—Ç–æ–∫ —Ç–æ–∂–µ —É–º—Ä–µ—Ç —Å–∞–º.
    t = threading.Thread(target=broadcast_loop, daemon=True)
    t.start()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º "–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –æ–ø—Ä–æ—Å" —Å–µ—Ä–≤–µ—Ä–æ–≤ Telegram (Long Polling).
    # –ë–æ—Ç –±—É–¥–µ—Ç –≤–∏—Å–µ—Ç—å —Ç—É—Ç –∏ –∂–¥–∞—Ç—å –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —é–∑–µ—Ä–æ–≤.
    bot.infinity_polling()

# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è Python.
# –ö–æ–¥ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é (python bot.py),
# –∞ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ –∫–∞–∫ –º–æ–¥—É–ª—å.
if __name__ == "__main__":
    main()

